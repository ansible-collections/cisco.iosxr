---
- ansible.builtin.debug: msg="END cliconf/cli_restore.yaml on connection={{ ansible_connection }}"

- block:
    - name: Prepare appliance for restore
      ansible.builtin.debug:
        msg:
          - "Task to prepare appliance for restore operation"

    - name: Overwrite startup config - archive
      cisco.iosxr.iosxr_config:
        lines:
          - "archive"

    - name: Delete iosxr hostname config
      register: result
      cisco.iosxr.iosxr_hostname:
        config:
        state: deleted

    - name: Add iosxr hostname config
      register: result
      cisco.iosxr.iosxr_hostname:
        config:
          hostname: "IOSXRTest"
        state: merged

    - name: Get running configuration
      register: result
      ansible.netcommon.cli_command:
        command: show configuration

    - name: Copy configuration to file
      ansible.builtin.copy:
        content: "{{ result['stdout'] }}"
        dest: /tmp/iosxr01.cfg

    - name: Modify interface ge-0/0/11 configuration
      ansible.buitin.replace:
        path: /tmp/iosxr01.cfg
        regexp: IOSXRTest
        replace: IOSXRTest restored

    - name: Copy config file to remote host
      ansible.netcommon.net_put:
        src: /tmp/iosxr01.cfg
        protocol: scp
        dest: "/misc/scratch/iosxr01.cfg"

    - name: Replace syslog test file configuration
      ansible.netcommon.cli_restore:
        filename: "flash:iosxr01.cfg"

    - name: Get hostname configuration
      register: result
      cisco.iosxr.iosxr_hostname:
        state: gathered

    - name: Assert that interface config change is reflected on device
      ansible.builtin.assert:
        that:
          - "'test cli_config restored' in  result.gathered.hostname"

    - name: Replace syslog test file configuration
      ansible.netcommon.cli_restore:
        filename: "/misc/scratch/iosxr01.cfg"

    - name: Assert that the previous task was idempotent
      ansible.builtin.assert:
        that:
          - result['changed'] == false

  always:
    - name: Delete hostname config
      cisco.iosxr.iosxr_hostname:
        state: deleted

    - name: Delete the backup file post backup
      cisco.iosxr.iosxr_command:
        commands:
          - command: "delete /misc/scratch/iosxr01.cfg"

- ansible.builtin.debug: msg="END cliconf/cli_restore.yaml on connection={{ ansible_connection }}"
