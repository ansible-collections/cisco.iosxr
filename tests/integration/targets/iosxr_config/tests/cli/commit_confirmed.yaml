---
- ansible.builtin.debug: 
    msg: "START cli/commit_confirmed.yaml on connection={{ ansible_connection }}"

- name: Pre-cleanup - Abort any existing config sessions
  cisco.iosxr.iosxr_command:
    commands:
      - "configure"
      - "abort"
  ignore_errors: true

- name: Test commit confirmed with rollback protection
  block:
    - name: Test commit confirmed functionality
      vars:
        ansible_iosxr_commit_confirmed: true
        ansible_iosxr_commit_confirmed_timeout: 60
      cisco.iosxr.iosxr_config:
        lines:
          - hostname iosxr_commit_confirmed

    - name: "Get hostname immediately after commit"
      register: get_hostname1
      cisco.iosxr.iosxr_command:
        commands:
          - "show running-config hostname"
      ignore_errors: true

    - name: Sleep for 90 secs for automatic rollback
      ansible.builtin.wait_for:
        timeout: 90

    - name: "Get hostname after rollback"
      register: get_hostname2
      cisco.iosxr.iosxr_command:
        commands:
          - "show running-config hostname"
      ignore_errors: true

    - ansible.builtin.assert:
        that:
          - "'iosxr_commit_confirmed' in get_hostname1.stdout[0]"
          - "'iosxr_commit_confirmed' not in get_hostname2.stdout[0]"

  rescue:
    - name: Test failed - wait for automatic rollback to complete
      ansible.builtin.debug:
        msg: "Test failed, waiting 70 seconds for rollback to complete"
    
    - name: Wait for rollback timer to expire
      ansible.builtin.wait_for:
        timeout: 70

  always:
    - name: Final cleanup - abort any config sessions
      cisco.iosxr.iosxr_command:
        commands:
          - "configure"
          - "abort"
      ignore_errors: true

    - ansible.builtin.debug: 
        msg: "END cli/commit_confirmed.yaml on connection={{ ansible_connection }}"
