---
- ansible.builtin.debug: msg="START cli/commit_confirmed.yaml on connection={{ ansible_connection }}"

- name: Test commit confirmed with guaranteed cleanup
  block:
    - name: Test commit confirmed functionality
      vars:
        ansible_iosxr_commit_confirmed: true
        ansible_iosxr_commit_confirmed_timeout: 60
      cisco.iosxr.iosxr_config:
        lines:
          - hostname iosxr_commit_confirmed

    - name: "Get hostname immediately after commit"
      register: get_hostname1
      cisco.iosxr.iosxr_command:
        commands:
          - "show running-config hostname"
      ignore_errors: true

    - name: Sleep for 90 secs for automatic rollback
      ansible.builtin.wait_for:
        timeout: 90

    - name: "Get hostname after rollback period"
      register: get_hostname2
      cisco.iosxr.iosxr_command:
        commands:
          - "show running-config hostname"
      ignore_errors: true

    - ansible.builtin.assert:
        that:
          - "'iosxr_commit_confirmed' in get_hostname1.stdout[0]"
          - "'iosxr_commit_confirmed' not in get_hostname2.stdout[0]"

  rescue:
    - name: Log test failure details
      ansible.builtin.debug:
        msg: "commit_confirmed test failed - {{ ansible_failed_result | default('unknown error') }}"

  always:
    - name: Cancel any remaining trial sessions (CRITICAL CLEANUP)
      cisco.iosxr.iosxr_config:
        lines:
          - commit confirmed cancel
      ignore_errors: true
      
    - ansible.builtin.debug: 
        msg: "END cli/commit_confirmed.yaml on connection={{ ansible_connection }}"
